# Contributor: Oleg A. Khlybov <fougas@mail.ru>

_realname=lis

pkgbase=mingw-w64-${_realname}
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=2.0.20
pkgrel=1
arch=('any')
pkgdesc="Sparse iterative linear solver library (mingw-w64)"
depends=("${MINGW_PACKAGE_PREFIX}-gcc-libs" "${MINGW_PACKAGE_PREFIX}-gcc-libgfortran" "${MINGW_PACKAGE_PREFIX}-msmpi")
makedepends=("${MINGW_PACKAGE_PREFIX}-gcc" "${MINGW_PACKAGE_PREFIX}-gcc-fortran")
optdepends=("buildtest: build testing support")
options=('strip' 'staticlibs')
license=('3-clause BSD')
url="http://www.ssisc.org/lis/"
source=("http://www.ssisc.org/lis/dl/${_realname}-${pkgver}.zip")
sha256sums=('07a8527fd243a881a745f55ea2a543379a05fc9262ba60098d26d5a4002a0265')
rootdir=`pwd`

prepare() {
  cd ${srcdir}/${_realname}-${pkgver}
  for p in ${srcdir}/../*.patch; do
	 patch -p1 < $p
  done
}

builds="dso dmo dto zso zmo zto cso cmo cto sso smo sto"

build() {
  cd ${srcdir}/${_realname}-${pkgver}
  for build in ${builds}; do
    opts="--enable-fortran --enable-f90 --enable-static --enable-shared"
    ld=gfortran
    ldflags=
    pc=
    case ${build} in
      ?m?)
        opts="${opts} --enable-mpi"
        ld=mpif90
      ;;
      ?t?)
        opts="${opts} --enable-omp"
        ldflags=-fopenmp
      ;;
    esac
    case ${build} in
      c*|z*)
        opts="${opts} --enable-complex"
      ;;
    esac
    [[ -d ${srcdir}/build-${MINGW_CHOST}-${build} ]] && rm -rf ${srcdir}/build-${MINGW_CHOST}-${build}
    mkdir -p ${srcdir}/build-${MINGW_CHOST}-${build} && cd ${srcdir}/build-${MINGW_CHOST}-${build}
    ../${_realname}-${pkgver}/configure ${opts}
    make
    cd src/.libs
    lib=liblis-${build}
    mv liblis.a ${lib}.a
    ${ld} -shared ${ldflags} -Wl,--enable-auto-import -Wl,--export-all-symbols -o ${lib}.dll -Wl,--out-implib,${lib}.dll.a -Wl,--whole-archive ${lib}.a -Wl,--no-whole-archive
  done
}

package() {
  mkdir -p ${pkgdir}${MINGW_PREFIX}/{bin,lib/pkgconfig,lib/lis,include/lis}
  cd ${srcdir}/${_realname}-${pkgver}/include
  cp lis.h lis_*.h ${pkgdir}${MINGW_PREFIX}/include/lis
  cd ${pkgdir}${MINGW_PREFIX}/include/lis
  (
    tests="${pkgdir}${MINGW_PREFIX}/share/tests"
    mkdir -p "$tests"
    cd "$rootdir/tests"
    cp -r * "$tests"
    cd "${srcdir}/${_realname}-${pkgver}/test"
    cp test4.c test7.c test1f.F test7f.F testmat.mtx "$tests/lis"
  )
  rm -f *_config*.h 
  for build in ${builds}; do
    cd ${srcdir}/build-${MINGW_CHOST}-${build}
    (
      cd src/.libs
      cp *.a ${pkgdir}${MINGW_PREFIX}/lib/lis
      cp *.dll ${pkgdir}${MINGW_PREFIX}/bin
    )
    (
      cd include
      mkdir -p ${pkgdir}${MINGW_PREFIX}/include/lis/${build}
      cp *.h ${pkgdir}${MINGW_PREFIX}/include/lis/${build}
    )
    lib=lis-${build}
    rmpi=
    cflags="-include lis_config.h"
    ldflags=
    case ${build} in
      ?m?)
        rmpi=msmpi
        cflags="${cflags} -DUSE_MPI"
      ;;
      ?t?)
        ldflags="${ldflags} -fopenmp"
      ;;
    esac
    echo "
      prefix=${MINGW_PREFIX}
      libdir=\${prefix}/lib/lis
      includedir=\${prefix}/include/lis
      Name: ${_realname}
      URL: ${url}
      Version: ${pkgver}
      Description: ${pkgdesc}
      Requires.private: ${rmpi}
      Cflags: -I\${includedir}/${build} -I\${includedir} ${cflags}
      Libs.private: ${ldflags} -L\${libdir} -l${lib} -lgfortran -lquadmath
      Libs: -L\${libdir} -l${lib}
    " | sed '/^\s*$/d;s/^\s*//' > ${pkgdir}${MINGW_PREFIX}/lib/pkgconfig/${lib}.pc
  done
}
