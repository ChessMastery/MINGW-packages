# Maintainer: Oleg A. Khlybov <fougas@mail.ru>

_realname='buildtest'
pkgbase=mingw-w64-${_realname}
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=1.0
pkgrel=1
pkgdesc="Extension to the Tcl's tcltest suite to build and run test programs (mingw-w64)"
url="https://github.com/okhlybov/buildtest"
license=('BSD')
arch=('any')
provides=("${MINGW_PACKAGE_PREFIX}-${_realname}")
depends=("${MINGW_PACKAGE_PREFIX}-tcl" "${MINGW_PACKAGE_PREFIX}-tcllib")
makedepends=("git")
source=("${_realname}"::"git+https://github.com/okhlybov/buildtest.git")
sha256sums=('SKIP')
rootdir=`pwd`

pkgver() {
  cd "${_realname}"
  echo 'set auto_path [linsert $auto_path 0 .]; puts [package require buildtest]' | tclsh
}

package() {
  ver=`pkgver`
  bindir="${pkgdir}${MINGW_PREFIX}/bin"
  libdir="${pkgdir}${MINGW_PREFIX}/lib/${_realname}${ver}"
  libexecdir="${pkgdir}${MINGW_PREFIX}/libexec"
  testdir="${pkgdir}${MINGW_PREFIX}/share/tests"
  for d in "$bindir" "$libdir" "$libexecdir" "$testdir"; do mkdir -p "$d"; done
  cd "${_realname}"
  cp buildtest.tcl pkgIndex.tcl "$libdir"
  cp tests/all.tcl "$testdir"
  cd "$rootdir"
  cflags="-O2 -DNDEBUG -s"
  cflags=-g
  gcc $cflags -o "$bindir/buildtests.exe" "$rootdir/buildtests.c"
  gcc -mwindows $cflags -o "$libexecdir/rmpath.exe" "$rootdir/rmpath.c" -lshlwapi
}
